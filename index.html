import React, { useState, useEffect } from 'react';
import { 
  TrendingUp, Clock, CheckCircle, Copy, FileText, Save, 
  Layout, Award, Archive, Trash2, PieChart, Star, Zap, 
  Target, Rocket, ShieldCheck, Lightbulb, Calendar, Palette
} from 'lucide-react';

/**
 * Mahmoud Yousry | Senior Graphic Designer
 * Elite Academy Performance Tracker V3.5
 * Features: Local Storage, Performance Scoring, Automated Report Generation
 */

const EliteDesignTracker = () => {
  const [activeTab, setActiveTab] = useState('input');
  const [showSaveSuccess, setShowSaveSuccess] = useState(false);

  // Initial State for the monthly tracker
  const [currentData, setCurrentData] = useState({
    id: Date.now(),
    month: new Date().toLocaleString('ar-EG', { month: 'long' }),
    year: new Date().getFullYear(),
    socialCount: 0,
    printCount: 0,
    presentationCount: 0,
    brandingCount: 0,
    adCreativeCount: 0,
    deliveryHours: 0,
    deliveryMinutes: 0,
    rushJobs: 0,
    avgRevisions: 0,
    bestCampaign: '',
    innovativeIdea: '',
    brandEnhancement: '',
    skillsLearned: '',
  });

  // Load history from local storage on mount
  const [history, setHistory] = useState(() => {
    const saved = localStorage.getItem('eliteDesignHistoryPro');
    return saved ? JSON.parse(saved) : [];
  });

  // Sync history to local storage whenever it changes
  useEffect(() => {
    localStorage.setItem('eliteDesignHistoryPro', JSON.stringify(history));
  }, [history]);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setCurrentData(prev => ({ ...prev, [name]: value }));
  };

  const totalDesigns = parseInt(currentData.socialCount || 0) + parseInt(currentData.printCount || 0) + 
                       parseInt(currentData.presentationCount || 0) + parseInt(currentData.brandingCount || 0) + 
                       parseInt(currentData.adCreativeCount || 0);

  // Algorithm to calculate performance score (0-100)
  const calculateScore = (data) => {
    let score = 0;
    const totalImpact = (parseInt(data.socialCount || 0) * 1) + (parseInt(data.printCount || 0) * 3) + 
                        (parseInt(data.brandingCount || 0) * 8) + (parseInt(data.adCreativeCount || 0) * 4);
    score += Math.min(totalImpact, 45); 
    
    const revPenalty = parseInt(data.avgRevisions || 0) * 8;
    score += Math.max(0, 25 - revPenalty);

    const timeInMinutes = (parseInt(data.deliveryHours || 0) * 60) + parseInt(data.deliveryMinutes || 0);
    if (timeInMinutes === 0) {
      score += 10; 
    } else {
      const speedScore = timeInMinutes < 180 ? 20 : (timeInMinutes < 1440 ? 15 : 10);
      score += speedScore;
    }

    if (data.innovativeIdea) score += 10;
    
    return Math.min(Math.round(score), 100);
  };

  const performanceScore = calculateScore(currentData);

  // Dynamic Badge System based on KPIs
  const getBadge = () => {
    if (parseInt(currentData.rushJobs) > 5) return { label: 'منقذ الأزمات', color: 'bg-orange-500', icon: ShieldCheck };
    if (parseInt(currentData.avgRevisions) === 0 && totalDesigns > 5) return { label: 'القناص (0 تعديلات)', color: 'bg-purple-600', icon: Target };
    if (performanceScore >= 90) return { label: 'خبير النخبة', color: 'bg-yellow-500 text-black', icon: Award };
    if (performanceScore >= 75) return { label: 'مصمم محترف', color: 'bg-blue-600', icon: Zap };
    return { label: 'بداية قوية', color: 'bg-slate-500', icon: TrendingUp };
  };

  const badge = getBadge();

  const saveReport = () => {
    const newEntry = { ...currentData, score: performanceScore, totalDesigns, dateSaved: new Date().toISOString() };
    const existingIndex = history.findIndex(h => h.month === currentData.month && h.year === currentData.year);
    const updatedHistory = existingIndex >= 0 ? [...history] : [...history, newEntry];
    if (existingIndex >= 0) updatedHistory[existingIndex] = newEntry;
    setHistory(updatedHistory);
    setShowSaveSuccess(true);
    setTimeout(() => setShowSaveSuccess(false), 3000);
  };

  const generateEmailText = () => {
    const timeStr = `${currentData.deliveryHours} ساعة و ${currentData.deliveryMinutes} دقيقة`;
    
    const rushJobText = parseInt(currentData.rushJobs) > 0 
      ? `- حالات الطوارئ: تم إنجاز ${currentData.rushJobs} طلبات عاجلة بنجاح دون التأثير على الجدول الزمني.`
      : `- استقرار العمل: تم تسليم كافة الأعمال وفق الجدول الزمني المخطط له بدقة تامة.`;

    const campaignText = currentData.bestCampaign 
      ? `- الإنجاز الأبرز: تنفيذ التصميمات الخاصة بـ "${currentData.bestCampaign}".` 
      : `- الإنجاز الأبرز: الحفاظ على نسق بصري موحد لجميع منشورات الأكاديمية.`;

    return `إلى: د. محمد شتات - المدير التنفيذي لأكاديمية النخبة الدولية للتدريب والتنمية

تحية طيبة،،

نرفع لسيادتكم تقرير الكفاءة الإبداعية لشهر ${currentData.month} ${currentData.year}.

[1] مؤشرات الإنتاج الفني (الإجمالي: ${totalDesigns} عمل فني):
- الحملات الممولة: ${currentData.adCreativeCount} | المطبوعات: ${currentData.printCount}
- الهوية البصرية: ${currentData.brandingCount} | التواصل الاجتماعي: ${currentData.socialCount}
- العروض التقديمية: ${currentData.presentationCount}

[2] معايير الجودة والسرعة:
- متوسط زمن التنفيذ: ${timeStr}
- معدل الدقة: ${currentData.avgRevisions} تعديل (مؤشر كفاءة تشغيلية).
${rushJobText}

[3] التطوير الاستراتيجي:
- المبادرة: ${currentData.innovativeIdea || "العمل على تحسين معايير الإخراج الفني للبراند."}
${campaignText}

نعمل دائماً لتعزيز القوة البصرية لأكاديمية النخبة دولياً.

الاحترام والتقدير،،
محمود يسري - قسم الجرافيك ديزاين`;
  };

  const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
  const years = [2024, 2025, 2026];

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-blue-100" dir="rtl">
      {/* Personalized Professional Header */}
      <header className="bg-white border-b border-slate-200 p-6 sticky top-0 z-50 shadow-sm">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
          <div className="flex items-center gap-4">
            <div className="bg-slate-900 p-3 rounded-2xl shadow-lg shadow-slate-200">
              <Palette className="text-white w-6 h-6" />
            </div>
            <div>
              <h1 className="text-xl font-black tracking-tight text-slate-800 flex flex-col sm:flex-row sm:items-baseline gap-2">
                Mahmoud Yousry 
                <span className="text-blue-600 font-medium text-sm sm:text-lg tracking-normal">| Senior Graphic Designer</span>
              </h1>
              <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">أكاديمية النخبة الدولية للتدريب والتنمية</p>
            </div>
          </div>

          <div className="flex items-center gap-4">
             <div className="flex -space-x-2 space-x-reverse">
                <div className={`px-4 py-2 rounded-xl border-2 border-white shadow-sm flex items-center gap-2 ${badge.color} text-white text-xs font-bold animate-pulse`}>
                   <badge.icon size={14} />
                   {badge.label}
                </div>
             </div>
             <div className="h-10 w-[1px] bg-slate-200 mx-2 hidden md:block"></div>
             <div className="text-left">
                <div className="text-[10px] text-slate-400 font-bold uppercase">KPI Score</div>
                <div className="text-xl font-black text-blue-600">{performanceScore}%</div>
             </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto p-4 md:p-8">
        
        {/* Navigation Tabs */}
        <div className="inline-flex p-1 bg-slate-200/50 rounded-2xl mb-8">
          {['input', 'report', 'history'].map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`px-8 py-2.5 rounded-xl text-sm font-bold transition-all ${
                activeTab === tab ? 'bg-white text-blue-600 shadow-md scale-100' : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              {tab === 'input' ? 'البيانات' : tab === 'report' ? 'التقرير' : 'الأرشيف'}
            </button>
          ))}
        </div>

        {activeTab === 'input' && (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Input Section */}
            <div className="lg:col-span-8 space-y-6">
              
              {/* Period Selector */}
              <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                 <div className="flex items-center gap-2 text-slate-500 font-bold text-sm">
                    <Calendar size={18} />
                    <span>فترة التقرير:</span>
                 </div>
                 <select 
                   name="month" 
                   value={currentData.month} 
                   onChange={handleInputChange}
                   className="bg-slate-50 border-none rounded-lg p-2 font-bold text-blue-900 focus:ring-2 focus:ring-blue-100 cursor-pointer"
                 >
                    {months.map(m => <option key={m} value={m}>{m}</option>)}
                 </select>
                 <select 
                   name="year" 
                   value={currentData.year} 
                   onChange={handleInputChange}
                   className="bg-slate-50 border-none rounded-lg p-2 font-bold text-blue-900 focus:ring-2 focus:ring-blue-100 cursor-pointer"
                 >
                    {years.map(y => <option key={y} value={y}>{y}</option>)}
                 </select>
              </div>

              <section className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                <div className="flex items-center gap-2 mb-8">
                  <PieChart className="text-blue-600" size={20} />
                  <h2 className="font-black text-slate-800">حجم الإنتاج الفني</h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <ModernInput label="سوشيال ميديا" name="socialCount" value={currentData.socialCount} onChange={handleInputChange} icon={Layout} />
                  <ModernInput label="إعلانات ممولة" name="adCreativeCount" value={currentData.adCreativeCount} onChange={handleInputChange} icon={Target} theme="blue" />
                  <ModernInput label="مطبوعات" name="printCount" value={currentData.printCount} onChange={handleInputChange} icon={FileText} />
                  <ModernInput label="عروض تقدمية" name="presentationCount" value={currentData.presentationCount} onChange={handleInputChange} icon={Award} />
                  <ModernInput label="هوية بصرية" name="brandingCount" value={currentData.brandingCount} onChange={handleInputChange} icon={Star} />
                  <ModernInput label="طلبات عاجلة" name="rushJobs" value={currentData.rushJobs} onChange={handleInputChange} icon={Zap} theme="orange" />
                </div>
              </section>

              <section className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                <div className="flex items-center gap-2 mb-6">
                  <Lightbulb className="text-yellow-500" size={20} />
                  <h2 className="font-black text-slate-800">الابتكار والتطوير الإبداعي</h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                   <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase">أبرز حملة تم إنجازها</label>
                      <input 
                        type="text"
                        name="bestCampaign" 
                        value={currentData.bestCampaign} 
                        onChange={handleInputChange}
                        placeholder="مثال: حملة دبلوم الموارد البشرية"
                        className="w-full bg-slate-50 border-2 border-transparent focus:border-blue-100 focus:bg-white p-4 rounded-2xl outline-none transition-all font-bold text-slate-700"
                      />
                   </div>
                   <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase">فكرة إبداعية جديدة</label>
                      <input 
                        type="text"
                        name="innovativeIdea" 
                        value={currentData.innovativeIdea} 
                        onChange={handleInputChange}
                        placeholder="تطوير موشن جرافيك أو نظام ألوان جديد"
                        className="w-full bg-slate-50 border-2 border-transparent focus:border-blue-100 focus:bg-white p-4 rounded-2xl outline-none transition-all font-bold text-slate-700"
                      />
                   </div>
                </div>
              </section>
            </div>

            {/* Side Analytics */}
            <div className="lg:col-span-4 space-y-6">
              <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                <h3 className="font-black mb-6 flex items-center gap-2"><Clock size={18}/> الكفاءة الزمنية والدقة</h3>
                <div className="space-y-6">
                   <div className="flex gap-4">
                      <div className="flex-1">
                        <label className="text-[10px] font-bold text-slate-400 block mb-2 uppercase">ساعات</label>
                        <input type="number" min="0" name="deliveryHours" value={currentData.deliveryHours} onChange={handleInputChange} className="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none border-2 border-transparent focus:border-blue-200" />
                      </div>
                      <div className="flex-1">
                        <label className="text-[10px] font-bold text-slate-400 block mb-2 uppercase">دقائق</label>
                        <input type="number" min="0" max="59" name="deliveryMinutes" value={currentData.deliveryMinutes} onChange={handleInputChange} className="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none border-2 border-transparent focus:border-blue-200" />
                      </div>
                   </div>
                   <div>
                      <label className="text-[10px] font-bold text-slate-400 block mb-2 uppercase">معدل التعديلات (Revisions)</label>
                      <input type="number" min="0" name="avgRevisions" value={currentData.avgRevisions} onChange={handleInputChange} className="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none border-2 border-transparent focus:border-blue-200" />
                      <p className="text-[10px] text-slate-400 mt-2">يعبر عن الدقة في فهم متطلبات الإدارة.</p>
                   </div>
                </div>
              </div>

              <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 text-white shadow-xl shadow-slate-200 relative overflow-hidden group">
                 <Zap className="absolute -right-4 -bottom-4 w-32 h-32 text-white/10 rotate-12 group-hover:rotate-0 transition-transform duration-700" />
                 <h4 className="font-black text-lg mb-2 relative z-10">نظام تقييم النخبة</h4>
                 <p className="text-slate-300 text-xs leading-relaxed relative z-10 font-medium">
                   هذا النظام يحلل التوازن بين الكم والكيف. حصولك على تقييم عالٍ يعني أنك تساهم مباشرة في الهوية البصرية والقوة التسويقية للأكاديمية.
                 </p>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'report' && (
          <div className="max-w-4xl mx-auto animate-in zoom-in-95 duration-300">
            <div className="bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden shadow-blue-900/5">
              <div className="bg-slate-900 p-8 text-white flex justify-between items-center">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center font-black text-xl">M</div>
                  <div>
                     <h3 className="font-black">تقرير الأداء التنفيذي</h3>
                     <p className="text-xs text-slate-400">إعداد: محمود يسري</p>
                  </div>
                </div>
                <div className="flex gap-3">
                   <button onClick={saveReport} className="bg-white/10 hover:bg-white/20 p-3 rounded-xl transition-all" title="حفظ للأرشيف"><Save size={20}/></button>
                   <button onClick={() => {navigator.clipboard.writeText(generateEmailText()); alert('تم نسخ التقرير بنجاح!');}} className="bg-blue-600 hover:bg-blue-500 p-3 rounded-xl transition-all" title="نسخ النص"><Copy size={20}/></button>
                </div>
              </div>
              <div className="p-12 text-slate-700 leading-[2.2] text-lg font-medium whitespace-pre-line border-r-[12px] border-blue-600 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:20px_20px]">
                {generateEmailText()}
              </div>
            </div>
            {showSaveSuccess && (
               <div className="mt-4 text-center text-green-600 font-bold animate-bounce">
                  تم حفظ التقرير في الأرشيف بنجاح!
               </div>
            )}
          </div>
        )}

        {activeTab === 'history' && (
          <div className="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
            <div className="flex items-center gap-2 mb-8">
               <Archive className="text-blue-600" />
               <h3 className="font-black text-xl text-slate-800">الأرشيف السنوي للإنجازات</h3>
            </div>
            {history.length === 0 ? (
              <div className="py-20 text-center text-slate-300 font-bold">لا توجد سجلات محفوظة حالياً.</div>
            ) : (
              <div className="space-y-4">
                {history.map((record, i) => (
                  <div key={i} className="flex items-center justify-between p-6 bg-slate-50 rounded-2xl border border-slate-100 hover:border-blue-200 transition-all group">
                    <div className="flex items-center gap-6">
                      <div className="text-center bg-white p-3 rounded-xl border border-slate-200 min-w-[100px]">
                        <div className="text-[10px] text-slate-400 font-black">{record.year}</div>
                        <div className="text-blue-600 font-black text-lg">{record.month}</div>
                      </div>
                      <div>
                        <div className="font-black text-slate-800 text-lg">{record.totalDesigns} عمل فني</div>
                        <div className="flex items-center gap-2 mt-1">
                           <div className="h-2 w-32 bg-slate-200 rounded-full overflow-hidden">
                              <div className="h-full bg-blue-500" style={{width: `${record.score}%`}}></div>
                           </div>
                           <span className="text-xs font-bold text-slate-500">تقييم الكفاءة: {record.score}%</span>
                        </div>
                      </div>
                    </div>
                    <button 
                      onClick={() => {
                        if(window.confirm('هل أنت متأكد من حذف هذا السجل؟')) {
                           setHistory(history.filter((_, idx) => idx !== i));
                        }
                      }}
                      className="opacity-0 group-hover:opacity-100 text-red-300 hover:text-red-500 p-2 transition-all"
                    >
                      <Trash2 size={20} />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </main>
      
      <footer className="max-w-7xl mx-auto p-8 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">
        © {new Date().getFullYear()} Mahmoud Yousry Design Portfolio Management System
      </footer>
    </div>
  );
};

/**
 * Reusable Modern Input Component
 */
const ModernInput = ({ label, name, value, onChange, icon: Icon, theme = "slate", min="0" }) => (
  <div className="group">
    <label className="text-[10px] font-black text-slate-400 mb-2 block uppercase tracking-tighter">{label}</label>
    <div className={`flex items-center gap-3 p-4 bg-slate-50 rounded-2xl border-2 border-transparent transition-all focus-within:bg-white shadow-sm focus-within:shadow-md ${theme === 'orange' ? 'focus-within:border-orange-100' : 'focus-within:border-blue-100'}`}>
      <Icon size={18} className={theme === 'orange' ? 'text-orange-400' : theme === 'blue' ? 'text-blue-500' : 'text-slate-400'} />
      <input 
        type="number"
        min={min}
        name={name} 
        value={value} 
        onChange={onChange}
        className="bg-transparent w-full outline-none font-black text-slate-700 text-lg"
      />
    </div>
  </div>
);

export default EliteDesignTracker;
